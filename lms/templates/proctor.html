<%! from django.utils.translation import ugettext as _ %>
<%namespace name='static' file='static_content.html'/>

% if is_staff:
<% override_label = "On" if staff_release else "Off" %>
<div aria-hidden="true" class="wrap-instructor-info">
    <a class="instructor-info-action" href="#proctor_admin_${element_id}" id="proctor_admin" rel="leanModal">${_("Proctor Student Admin")}</a>
    <a class="instructor-info-action" href="#proctor_history_${element_id}" id="proctor_history" rel="leanModal">${_("Proctor Submission History")}</a>
    <a class="instructor-info-action" href="#proctor_release_${element_id}" id="proctor_override">${_("Proctor Override")}: <b>${_(override_label)}</b></a>
</div>
<hr/>

<section aria-hidden="true" class="modal history-modal" id="proctor_admin_${element_id}" style="width:80%; left:20%; height:80%; overflow:auto;" >
  <div class="inner-wrapper" style="color:black">
    <header>
      <h2>${_("Proctor Student Admin")}</h2>
    </header>
    <form id="proctor_${element_id}_reset_form">
      <label for="proctor_${element_id}_student_username">${_("User:")}</label>
      <input name="username" id="proctor_${element_id}_student_username" type="text" placeholder=""/>
      <input name="all_problems" id="proctor_${element_id}_all_problems" type="checkbox"/> Reset all problems?<br/>
      <input name="wipe_history" id="proctor_${element_id}_wipe_history" type="checkbox"/> Wipe randomize history?
      <input name="location" type="hidden" id="proctor_${element_id}_reset_location" value="${location}"/>
      <div class="submit">
          <button id="proctor_${element_id}_submit" name="submit" type="submit">${_("Reset Attempts")}</button>
      </div>
    </form>
    <div id="proctor_${element_id}_text" class="staff_info" style="display:block">
    </div>
  </div>
</section>

<section aria-hidden="true" class="modal history-modal" id="proctor_history_${element_id}" style="width:80%; left:20%; height:80%; overflow:auto;" >
  <div class="inner-wrapper" style="color:black">
    <header>
      <h2>${_("Proctor Submission History")}</h2>
    </header>
    <form id="proctor_${element_id}_history_form">
      <label for="proctor_${element_id}_student_username_hist">${_("User:")}</label>
      <input name="username" id="proctor_${element_id}_student_username_hist" type="text" placeholder=""/>
      <input name="location" type="hidden" id="proctor_${element_id}_hist_location" value="${location}"/>
      <div class="submit">
          <button id="proctor_${element_id}_hist_submit" name="submit" type="submit">${_("Fetch Submission History")}</button>
      </div>
    </form>
    <div id="proctor_${element_id}_hist_text" class="staff_info" style="display:block">
    </div>
  </div>
</section>

<script type="text/javascript">
proctor_override = function(){
    var data = {enabled: "${not staff_release}"};
    $.post( "${ajax_url}/override", data, function( data ) {
        location.reload();
    });
}
$('#proctor_override').click(proctor_override);

setup_form = function(url, form_el, uname_el, submit_el, text_el, success){
    var submit_text = submit_el.html()

    form_el.submit(function(e) {
        e.preventDefault();
        submit_el.attr("disabled", true);
        submit_el.html('${_("Processing, please wait...")}');
        text_el.html("");
        $.ajax({
            url: url,
            type: 'POST',
            dataType: 'json',
            data: form_el.serialize(),
            success: success,
            error: function(xhr, stat, error){
                console.debug(xhr);
                console.debug(stat);
                console.debug(error);
                text_el.html('FATAL: ' + error);
             },
            complete: function(){
                submit_el.removeAttr("disabled");
                submit_el.html(submit_text);
            },
        });
        return false;
    });
}

reset_success = function(data) {
    var text_el = $('#proctor_${element_id}_text');
    var uname_el = $('#proctor_${element_id}_student_username');
    var msg = '';
    if ('error' in data) {
        msg = "ERROR: " + data['error'];
    } else {
        var uname = uname_el.val();
        msg = "Successfully reset attempts for user: " + uname;
    }
    text_el.html(msg);
}

setup_form('${ajax_url}/reset',
           $('#proctor_${element_id}_reset_form'),
           $('#proctor_${element_id}_student_username'),
           $('#proctor_${element_id}_submit'),
           $('#proctor_${element_id}_text'),
           reset_success);

hist_success = function(data) {
    var text_el = $('#proctor_${element_id}_hist_text');
    var uname_el = $('#proctor_${element_id}_student_username_hist');
    var msg = '';
    if ('error' in data) {
        msg = "ERROR: " + data['error'];
    } else {
        var uname = uname_el.val();
        msg = "Submission history for " + uname + ":\n" + JSON.stringify(data, undefined, 2);
    }
    text_el.html(msg);
}

setup_form('${ajax_url}/submission_history',
           $('#proctor_${element_id}_history_form'),
           $('#proctor_${element_id}_student_username_hist'),
           $('#proctor_${element_id}_hist_submit'),
           $('#proctor_${element_id}_hist_text'),
           hist_success);

</script>

% endif

% if not is_released:

<div>
    <h2>Welcome: <b>${pp.user.profile.name or pp.user}</b></h2>

    <p>
    Access has been requested for <b>${name}</b> but it hasn't been released
    yet.
    </p>
    <p>
    This page will automatically reload once access has been granted.
    </p>
    <p>
    Please see your instructor or TA if access is not granted soon.
    </p>
</div>

<script type="text/javascript">
procrel = (function(){
    var el = $('#proctor_${element_id}');
    var skiperr = false;
    var set_skiperr = function(){ skiperr = true; }
    var check_count = 0;
    var interval = null;

    var _do_pp = function(cmd, type, gfun){
        $.ajax({ url: "${ajax_url}/" + cmd,
                 type: type,
                 success: gfun,
		 dataType: "json",
                 error: function(xhr, status, error) {
		     if (!skiperr){
                         console.log('Error: cannot connect to server ' + status + " error: " + error);
		     }
                 }
        });
    }

    var do_pp_get = function(cmd, gfun){
        return _do_pp(cmd, 'GET', gfun);
    }

    var check_access = function(){
        do_pp_get('status', function(data){
	    console.log(data);
	    if (data.enabled) {
                if (interval != null) {
                    console.log("clearing interval for check_access");
                    clearInterval(interval);
                }
	        console.log("Access Granted!");
		location.reload();
	    }
	});
    }

    var periodic_check = function() {
        if (interval == null) {
            console.log("setting interval for check_access");
            interval = setInterval(check_access, 2000);
        } else {
            console.log("interval already set for check_access");
        }
    }

    periodic_check();
}());
</script>

% elif child_html is not None:

${child_html}

% endif
