<%! from django.utils.translation import ugettext as _ %>
<%namespace name='static' file='static_content.html'/>

% if is_staff:
<% override_label = "On" if staff_release else "Off" %>
<div aria-hidden="true" class="wrap-instructor-info">
    <a class="instructor-info-action" href="#proctor_admin_${element_id}" id="proctor_admin" rel="leanModal">${_("Proctor Student Admin")}</a>
    <a class="instructor-info-action" href="#proctor_release_${element_id}" id="proctor_override">${_("Proctor Override")}: <b>${_(override_label)}</b></a>
</div>
<hr/>

<section aria-hidden="true" class="modal history-modal" id="proctor_admin_${element_id}" style="width:80%; left:20%; height:80%; overflow:auto;" >
  <div class="inner-wrapper" style="color:black">
    <header>
      <h2>${_("Proctor Student Admin")}</h2>
    </header>
    <form id="proctor_${element_id}_reset_form">
      <label for="proctor_${element_id}_student_username">${_("User:")}</label>
      <input name="username" id="proctor_${element_id}_student_username" type="text" placeholder=""/>
      <input name="location" type="hidden" id="proctor_${element_id}_reset_location" value="${location}"/>
      <div class="submit">
          <button id="proctor_${element_id}_submit" name="submit" type="submit">${_("Reset Attempts")}</button>
      </div>
    </form>
    <div id="proctor_${element_id}_text" class="staff_info" style="display:block">
    </div>
  </div>
</section>

<script type="text/javascript">
proctor_override = function(){
    var data = {enabled: "${not staff_release}"};
    $.post( "${ajax_url}/override", data, function( data ) {
        location.reload();
    });
}
$('#proctor_override').click(proctor_override);

$('#proctor_${element_id}_reset_form').submit(function(e) {
    e.preventDefault();
    $('#proctor_${element_id}_submit').attr("disabled", true);
    $('#proctor_${element_id}_submit').html('${_("Processing, please wait...")}');
    $('#proctor_${element_id}_text').html("");
    $.ajax({
        url: '${ajax_url}/reset',
        type: 'POST',
        dataType: 'json',
        data: $('#proctor_${element_id}_reset_form').serialize(),
        success: function(data) {
            var msg = '';
            if ('error' in data) {
                msg = "ERROR: " + data['error'];
            } else {
                var uname = $('#proctor_${element_id}_student_username').val();
                msg = "Successfully reset attempts for user: " + uname;
            }
            $('#proctor_${element_id}_text').html(msg);
        },
        error: function(xhr, stat, error){
            console.debug(xhr);
            console.debug(stat);
            console.debug(error);
            $('#proctor_${element_id}_text').html('FATAL: ' + error);
         },
        complete: function(){
            $('#proctor_${element_id}_submit').removeAttr("disabled");
            $('#proctor_${element_id}_submit').html('${_("Reset Attempts")}');
        },
    });
    return false;
});
</script>

% endif

% if not is_released:

<div>
    <h2>Welcome: <b>${pp.user.profile.name or pp.user}</b></h2>

    <p>${name} has not been released</p>

    <div id="proctor_stat_${element_id}"></div>

    <p><input id="proctor_${element_id}" type="button" value="Request Access"></p>

</div>

<script type="text/javascript">
procrel = (function(){
    var el = $('#proctor_${element_id}');

    var skiperr = false;

    var set_skiperr = function(){ skiperr = true; }

    var statel = $('#proctor_stat_${element_id}');

    var setstat = function(status){
        statel.html('<p><font color="green">' + status + '</font></p>');
    }

    var _do_pp = function(cmd, type, gfun){
        $.ajax({ url: "${ajax_url}/" + cmd,
                 type: type,
                 success: gfun,
		 dataType: "json",
                 error: function(xhr, status, error) {
		     if (!skiperr){
                         console.log('Error: cannot connect to server ' + status + " error: " + error);
		     }
                 }
        });
    }

    var do_pp_get = function(cmd, gfun){
        return _do_pp(cmd, 'GET', gfun);
    }

    var do_pp_post = function(cmd, gfun){
        return _do_pp(cmd, 'POST', gfun);
    }

    var check_access = function(){
        do_pp_get('status', function(data){
	    console.log(data);
	    if (data.enabled) {
                if (interval != null) {
                    console.log("clearing interval for check_access");
                    clearInterval(interval);
                }
	        console.log("Access Granted!");
		location.reload();
	    }
	});
    }

    var check_count = 0;

    var interval = null;

    var periodic_check = function() {
        if (interval == null) {
            console.log("setting interval for check_access");
            interval = setInterval(check_access, 2000);
        } else {
            console.log("interval already set for check_access");
        }
    }

    var make_request = function(){
        check_count = 0;
	do_pp_post('request', function(result, status, xhr){
            setstat(result.status);
            periodic_check();
        });
    }

    el.click(make_request);

    return {
            "check": check_access,
            "make": make_request,
            "do_pp_get": do_pp_get,
            "do_pp_post": do_pp_post,
            "set_skiperr": set_skiperr
    };

}());
</script>

% elif child_html is not None:

${child_html}

% endif
