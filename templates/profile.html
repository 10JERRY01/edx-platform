<%inherit file="main.html" />
<%namespace name="profile_graphs" file="profile_graphs.js"/>
<%namespace name="survey_fields" file="survey_fields.html"/>

<%block name="title"><title>Profile - MITx 6.002x</title></%block>

<%!
    from django.core.urlresolvers import reverse
    from django.conf import settings
%>

<%block name="headextra">
<script type="text/javascript" src="/static/js/flot/jquery.flot.js"></script>
<script type="text/javascript" src="/static/js/flot/jquery.flot.stack.js"></script>
<script type="text/javascript" src="/static/js/flot/jquery.flot.symbol.js"></script>
<script>
${profile_graphs.body(grade_sheet['grade_summary'], grade_cutoffs, "grade-detail-graph")}
</script>

<script>
var loc=true; // Activate on clicks? Not if already clicked.
var lang=true;
$(function() {
      $("#change_location").click(function() {
         $(this).hide();

         log_event("profile", {"type":"location_show", "old":$("#location_sub").text()});

         if(loc) {
           $("#description").html('<div>'+
                                  "Preferred format is city, state, country (so for us, "+
                                  "&quot;Cambridge, Massachusetts, USA&quot;), but give "+
                                  "as much or as little detail as you want. </div>");

           loc=false;

           $("#location_sub").html('<form>'+'<input id="id_loc_text" type="text" name="loc_text" />'+
             '<input type="submit" id="change_loc_button" value="Save" />'+'</form>');

           $("#change_loc_button").click(function() {
             $("#change_location").show();

              postJSON('/change_setting', {'location':$("#id_loc_text").attr("value")}, function(json) {
                $("#location_sub").text(json.location);
                loc=true;
                $("#description").html("");
               log_event("profile", {"type":"location_change", "new":json.location});
              });
           });
         }
      });

      $("#change_language").click(function() {
         $(this).hide();
         log_event("profile", {"type":"language_show", "old":$("#language_sub").text()});

         if(lang) {
           lang=false;
           $("#language_sub").html('<form>'+'<input id="id_lang_text" type="text" name="lang_text" />'+
             '<input type="submit" id="change_lang_button" value="Save" />'+'</form>');
           $("#change_lang_button").click(function() {
             $("#change_language").show();
              postJSON('/change_setting', {'language':$("#id_lang_text").attr("value")}, function(json) {
                $("#language_sub").text(json.language);
                lang=true;
                $("#description").html("");
               log_event("profile", {"type":"language_change", "new":json.language});
              });
           });
         }
      });

      $('#change_password').click(function(){
        $('.modal').trigger('click');
        log_event("profile", {"type":"password_show"});
      });

    $('#pwd_reset_button').click(function() {
      $.post('/password_reset/',{ "csrfmiddlewaretoken" : "${ csrf }",
                    "email"  : $('#id_email').val()}, function(data){
         $("#password_reset_complete_link").click();
         log_event("profile", {"type":"password_send"});
      });
    });


    $("#change_email_form").submit(function(){
      var new_email = $('#new_email_field').val();
      var new_password = $('#new_email_password').val();

      postJSON('/change_email',{"new_email":new_email, 
                                "password":new_password},
               function(data){
          if(data.success){
          $("#change_email").html("<h1>Please verify your new email</h1><p>You'll receive a confirmation in your in-box. Please click the link in the email to confirm the email change.</p>");
          } else {
            $("#change_email_error").html(data.error);
          }
       });
       log_event("profile", {"type":"email_change_request", 
                               "old_email":"${email}",
                               "new_email":new_email});
       return false;
    });
    

    $("#change_name_form").submit(function(){
      var new_name = $('#new_name_field').val();
      var rationale = $('#name_rationale_field').val();

      postJSON('/change_name',{"new_name":new_name, 
                                "rationale":rationale},
               function(data){
          if(data.success){
          $("#survey").html("<h1>Your request has been submitted.</h1><p>We'll send you an e-mail when approve the change or need further information. Please allow for up to a week for us to process your request.</p>");
          } else {
            $("#change_name_error").html(data.error);
          }
       });
       log_event("profile", {"type":"name_change_request", 
                               "new_name":new_name,
                               "rationale":rationale});
       return false;
    });
    
    %if settings.END_COURSE_ENABLED:
    //This is used to scroll error divs to the user's attention. It can be removed when we switch to the branch with jQuery.ScrollTo
    jQuery.fn.scrollMinimal = function(smooth) {
      var cTop = this.offset().top;
      var cHeight = this.outerHeight(true);
      var windowTop = $(window).scrollTop();
      var visibleHeight = $(window).height();
      
      if (cTop < windowTop) {
        $('body').animate({'scrollTop': cTop}, 'slow', 'swing');
      } else if (cTop + cHeight > windowTop + visibleHeight) {
        $('body').animate({'scrollTop': cTop - visibleHeight + cHeight}, 'slow', 'swing');
      }
    };
    
    /*
    There is a fieldset, #survey_fieldset, which contains an exit survey. This exist survey can be taken by iteself,
    or as part of the certificate request. If they haven't taken the survey yet, it moves to the open modal dialogue.
    Once it has been taken, it should dissapear.
    */
    $("a.cert_request_link").click(function(){
      //If they haven't taken the survey yet, we move it to the certificate request form
      if ($("#survey_fieldset").length>0) {
        $("#cert_request_survey_holder").prepend( $("#survey_fieldset") );
      }
    });
    $("a.survey_link").click(function(){
      // They survey may have been "stolen" away to the certificate request form
      if ($("#survey_fieldset").length>0) {
        $("#survey_survey_holder").prepend( $("#survey_fieldset") );
      }
    });
    
    $("#cert_request_form").submit(function(){
      var values = {'cert_request_honor_code_verify' : $("#cert_request_honor_code_verify").is(':checked'),
                    'cert_request_name_verify' : $("#cert_request_name_verify").is(':checked'),
                    'cert_request_id_verify' : $("#cert_request_id_verify").is(':checked'),
                  };
      
      postJSON('/certificate_request', values, function(data) {
        if (data.success) {
          
          //Now we move the survey_survey_holder back to a safer container, and submit the survey
          if ($("#survey_fieldset").length>0) {
            $("#survey_survey_holder").prepend( $("#survey_fieldset").remove() );
            
            $("#survey_form").submit();
          }
          
          $("#cert_request").html("<h1>Certificate Request Received</h1><p>Thank you! A certificate is being generated. You will be notified when it is ready to download.</p>");
          $(".cert_request_link").text("Certificate is being generated...");
        } else {
          $("#cert_request_error").html(data.error).scrollMinimal();
        }
      });
      log_event("certificate_request", values);
      return false;
    });
    
    $("#survey_form").submit(function(){
      var values = {};
      
      //First we set the value of every input to null. This assures that even
      //if a checkbox isn't checked or a question isn't answered, its name is
      //still in the dictionary so we know the question was on the form.
      var inputs = $("#survey_fieldset :input");
      inputs.each( function(index, element) {
        values[ element.getAttribute("name") ] = null;
      });
      
      //Grab the values from the survey_fieldset
      var serializedArray = inputs.serializeArray();
      for (var i = 0; i < serializedArray.length; i++) {
        var key = serializedArray[i]['name'];
        var value = serializedArray[i]['value'];
        if ( key in values && values[key] != null) {
          values[key].push( value );
        } else {
          values[key] = [value];
        }
      }
      
      postJSON('/record_exit_survey', {'survey_results' : JSON.stringify(values)}, function(data) {
        if (true || data.success) {
          $("#survey").html("<h1>Survey Response Recorded</h1><p>Thank you for filling out the survey!</p>");
          
          //Make sure that the survey fieldset is removed
          $("#survey_fieldset").remove();
          
          //Remove the links to take the survey
          $(".survey_offer").hide();
        } else {
          $("#survey_error").html(data.error).scrollMinimal();
        }
      });
      log_event("exit_survey_submission", values);
      return false;
    });
    %endif
    
});
</script>
</%block>


<%include file="navigation.html" args="active_page='profile'" />

<section class="main-content">
  <div class="profile-wrapper">

    <section class="course-info">
      <header>
        <h1>Course Progress</h1>
      </header>

      %if settings.END_COURSE_ENABLED:
      <div id="grade">
        %if grade_sheet['grade']:
          <p>Final Grade: <strong>${grade_sheet['grade']}</strong></p>
          
          %if not certificate_requested:
            <a rel="leanModal" class="cert_request_link" href="#cert_request">Request Certificate</a>
          %elif certificate_download_url:
            <a href="${certificate_download_url}" target="_blank">Download Certificate</a>
          %else:
            <a href="#">Certificate is being generated...</a>
          %endif
        %else:
          <p> No letter grade has been earned for this course </p>
        %endif
        
        %if not took_survey:
        <div class="survey_offer">
          <a class="survey_link" rel="leanModal" href="#survey">Take the survey</a>.
        </div>
        %endif
      </div>

      %endif

      <div id="grade-detail-graph"></div>

      <ol class="chapters">
        %for chapter in grade_sheet['courseware_summary']:
        %if not chapter['chapter'] == "hidden":
        <li>
          <h2><a href="${reverse('courseware_chapter', args=format_url_params([chapter['course'], chapter['chapter']])) }">
          ${ chapter['chapter'] }</a></h2>

          <ol class="sections">
            %for section in chapter['sections']:
            <li>
              <%
              earned = section['section_total'].earned
              total = section['section_total'].possible
              percentageString = "{0:.0%}".format( float(earned)/total) if earned > 0 and total > 0 else ""
              %>
              
              <h3><a href="${reverse('courseware_section', args=format_url_params([chapter['course'], chapter['chapter'], section['section']])) }">
                ${ section['section'] }</a> ${"({0:.3n}/{1:.3n}) {2}".format( float(earned), float(total), percentageString )}</h3>
              ${section['subtitle']}
              %if 'due' in section and section['due']!="":
                due ${section['due']}
              %endif
              
              %if len(section['scores']) > 0:
                <ol class="scores">
                  ${ "Problem Scores: " if section['graded'] else "Practice Scores: "}
                  %for score in section['scores']:
                    <li class="score">${"{0:.3n}/{1:.3n}".format(float(score.earned),float(score.possible))}</li>
                  %endfor
                </ol>
              %endif
              
            </li> <!--End section-->
            %endfor
          </ol> <!--End sections-->
        </li> <!--End chapter-->
        %endif
        %endfor
      </ol> <!--End chapters-->

    </section>

    <section class="user-info">

      <header>
        <h1>Student Profile</h1>
      </header>

      <ul>
        <li>
          Name: <strong>${name}</strong>
          %if True:
          <a href="#apply_name_change" rel="leanModal" class="name-edit">Edit</a>
          %else:
          (Name change pending)
          %endif
        </li>

        <li>
          Forum name: <strong>${username}</strong> 
        </li>

        <li>
          E-mail: <strong>${email}</strong> <a href="#change_email" rel="leanModal" class="edit-email">Edit</a>
        </li>
        <li>
          Location: <div id="location_sub">${location}</div><div id="description"></div> <a href="#" id="change_location">Edit</a>
        </li>
        <li>
          Language: <div id="language_sub">${language}</div> <a href="#" id="change_language">Edit</a>
        </li>
        <li>
          Password reset
          <input id="id_email" type="hidden" name="email" maxlength="75" value="${email}" />
          <input type="submit" id="pwd_reset_button" value="Reset" />
          <p>We'll e-mail a password reset link to ${email}.</p>
        </li>
      </ul>

    </section>
  </div>
</section>

<div id="password_reset_complete" class="leanModal_box">
  <a href="#password_reset_complete" rel="leanModal" id="password_reset_complete_link"></a>
  <h1>Password Reset Email Sent</h1>
  <p>
    An email has been sent to ${email}. Follow the link in the email to change your password.
  </p>
</div>

<div id="apply_name_change" class="leanModal_box">
  <h1>Apply to change your name</h1>
  <form id="change_name_form">
    <div id="change_name_error"> </div>
    <fieldset>
      <p>To uphold the credibility of MITx certificates, name changes must go through an approval process. A member of the course staff will review your request, and if approved, update your information. Please allow up to a week for your request to be processed. Thank you.</p> 
      <ul>
        <li>
          <label>Enter your desired full name, as it will appear on the MITx Certificate: </label>
          <input id="new_name_field" value="" type="text" />
        </li>
        <li>
          <label>Reason for name change:</label>
          <textarea id="name_rationale_field" value=""></textarea>
        </li>
        <li>
          <input type="submit" id="submit">
        </li>
      </ul>
    </fieldset>
  </form>
</div>

<div id="change_email" class="leanModal_box">
  <h1>Change e-mail</h1> 
  <div id="apply_name_change_error"></div>
  <form id="change_email_form">
    <div id="change_email_error"> </div>
    <fieldset>
      <ul>
        <li>
          <label> Please enter your new email address: </label>
          <input id="new_email_field" type="email" value="" />
        </li>

        <li>
          <label> Please confirm your password: </label>
          <input id="new_email_password" value="" type="password" />
        </li>
        <li>
          <p>We will send a confirmation to both ${email} and your new e-mail as part of the process.</p>
          <input type="submit" id="submit_email_change" />
        </li>
      </ul>
      </fieldset>
    </form>
</div>

<div id="deactivate-account" class="leanModal_box">
  <h1>Deactivate MITx Account</h1>
  <p>Once you deactivate you&rsquo;re MIT<em>x</em> account you will no longer recieve updates and new class announcements from MIT<em>x</em>.</p>
  <p>If you&rsquo;d like to still get updates and new class announcements you can just <a href="#unenroll" rel="leanModal">unenroll</a> and keep your account active.</p>

  <form id="unenroll_form">
    <div id="unenroll_error"> </div>
    <fieldset>
      <ul>
        <li>
          <input type="submit" id="" value="Yes, I don't want an MITx account or hear about any new classes or updates to MITx" />
        </li>
      </ul>
    </fieldset>
  </form>
</div>

<div id="unenroll" class="leanModal_box">
  <h1>Unenroll from 6.002x</h1>
  <p>Please note: you will still receive updates and new class announcements from MIT<em>x</em>. If you don&rsquo;t wish to receive any more updates or announcements <a href="#deactivate-account" rel="leanModal">deactivate your account</a>.</p>

  <form id="unenroll_form">
    <div id="unenroll_error"> </div>
    <fieldset>
      <ul>
        <li>
          <input type="submit" id="" value="Yes, I want to unenroll from 6.002x but still hear about any new classes or updates to MITx" />
        </li>
      </ul>
    </fieldset>
  </form>
</div>

%if grade_sheet['grade']:
<div id="cert_request" class="leanModal_box">
  <h1>Request a 6.002x Certificate</h1>
  <p>You can request a certificate which verifies that you passed this course. When the certificate has been generated, you will receive an email notification that it can be downloaded from your Profile page.</p>
  <p>The certificate will indicate that <strong>${name}</strong> has successfully completed the Fall 2012 offering of <strong>Circuits and Electronics 6.002x</strong>. Please ensure that this information is correct.</p>
  
  <form id="cert_request_form">
    <fieldset id="cert_request_fieldset">
      <div id="cert_request_error"> </div>
      <ul>
        <li class="verify">
          <input type="checkbox" id="cert_request_honor_code_verify"/>
          <label> I certify that I have not violated the Honor Code for this course. </label>
        </li>
        <li class="verify">
          <input type="checkbox" id="cert_request_name_verify"/>
          <label> The name shown above is correct. </label>
        </li>
        <li class="verify">
          <input type="checkbox" id="cert_request_id_verify"/>
          <label> I understand that my certificate contains my name a unique ID which will be visible on the certificate. I will give this ID only to those who I wish to visit the verification page on www.edXOnline.org to confirm that I passed Circuits and Electronics 6.002x. </label>
        </li>
      </ul>
    </fieldset>
    
    <div id="cert_request_survey_holder"> </div>
    
    <input type="submit" id="" value="Generate Certificate" />
    
  </form>
</div>
%endif

%if not took_survey:
<div id="survey" class="leanModal_box">
  <form id="survey_form">    
    <div id="survey_survey_holder">    
      <fieldset id="survey_fieldset">
        <h1>Thank you for taking 6.002x! You could help us a lot by filling out this (optional) survey.</h1>
        <p>This survey is collected only for research purposes. It is completely optional and will not affect your grade.</p>
        
        <div id="survey_error"> </div>
        
        ${survey_fields.body(survey_list)}
        
      </fieldset>
    </div>
    
    <input type="submit" id="" value="Record Survey Response" />
    
  </form>
</div>
%endif
